System.register(["vue","@ibiz-template/vue3-util","@ibiz-template/runtime","@ibiz-template/core","lodash-es","qx-util"],(function(e){"use strict";var t,i,n,r,a,o,s,c,l,u,d,h,p,m,v,f,y,b,w,g,D,I,O,j,S,C,E,A,L,P,N,x,T,V;return{setters:[function(e){t=e.defineComponent,i=e.onMounted,n=e.onUnmounted,r=e.ref,a=e.createVNode,o=e.createTextVNode,s=e.resolveComponent,c=e.computed,l=e.nextTick,u=e.watch,d=e.withDirectives,h=e.resolveDirective,p=e.isVNode},function(e){m=e.useNamespace,v=e.useUIStore},function(e){f=e.Method,y=e.findAppDEMethod,b=e.getDEMethodProvider,w=e.execFieldLogics,g=e.findDELogic,D=e.execDELogicAction,I=e.ScriptFactory,O=e.registerDEMethodProvider,j=e.PanelItemState,S=e.QXEventEx,C=e.PanelItemController,E=e.registerPanelItemProvider},function(e){A=e.RuntimeError,L=e.HttpResponse,P=e.RuntimeModelError,N=e.HttpError},function(e){x=e.isArray,T=e.isNil},function(e){V=e.notNilEmpty}],execute:function(){var k=t({name:"IBizLocalVersionContainer",props:{controller:{type:Object,required:!0},dismiss:{type:Function,required:!0}},setup(e){const t=m("local-version-container"),a=e.controller.evt,{overUpNumber:o,overUpIsClean:s}=e.controller.getOverUpState(),c=()=>{e.dismiss()};i((()=>{a.on("close",c)})),n((()=>{a.off("close",c)}));const l=r(s);return{ns:t,closeDrawer:c,cleanState:l,overUpNumber:o,setCleanState:t=>{l.value=t,e.controller.setOverUpState(t)},clearHistoryVersion:()=>{e.controller.deleteAll()}}},render(){return a("div",{class:this.ns.b()},[a("div",{class:this.ns.e("header")},[a("div",{class:this.ns.e("header-left")},[o("历史版本")]),a("div",{class:this.ns.e("header-right")},[a(s("el-button"),{title:"关闭",class:this.ns.e("header-button"),onClick:()=>this.closeDrawer()},{default:()=>[a("i",{class:"fa fa-sign-out"},null),a("span",null,[o("关闭")])]})])]),a("div",{class:this.ns.e("body")},[a(s("iBizLocalVersionList"),{controller:this.controller},null)]),a("div",{class:this.ns.e("footer")},[a(s("el-checkbox"),{"model-value":this.cleanState,onChange:this.setCleanState,label:"自动清理旧版本（保留最多".concat(this.overUpNumber,"个）")},null),a(s("el-button"),{title:"清空历史版本",class:this.ns.e("footer-button"),onClick:()=>this.clearHistoryVersion()},{default:()=>[a("i",{class:"fa fa-trash"},null),a("span",null,[o("清空历史版本")])]})])])}}),z=t({name:"IBizLocalVersionList",props:{controller:{type:Object,required:!0}},setup(e){const t=m("local-version-list"),a=r([]),o=r(""),s=e.controller.evt,c=async t=>{const i=e.controller;a.value=t?await i.fetchAll(t):await i.fetchAll()};i((async()=>{await c(),s.on("deleteAll",c)})),n((()=>{s.off("deleteAll",c)}));return{ns:t,query:o,items:a,handleAction:(t,i,n)=>{switch(t){case"apply":(async t=>{const i=e.controller;await i.apply(t)})(i);break;case"remove":(async t=>{const i=e.controller;await i.remove(t)&&(a.value=await i.fetchAll())})(i);break;case"diff":e.controller.diff(i,a.value);break;default:console.error("".concat(t," is not support"))}},handleQueryChange:async e=>{await c(e)}}},render(){return a("div",{class:this.ns.b()},[a("div",{class:this.ns.e("search")},[a(s("el-input"),{modelValue:this.query,"onUpdate:modelValue":e=>this.query=e,style:"width: 100%",placeholder:"请输入历史版本名称进行过滤","suffix-icon":a("ion-icon",{class:this.ns.e("search-icon"),style:"cursor: pointer;",name:"search"},null),onChange:e=>{this.handleQueryChange(e)},clearable:!0},null)]),a("div",{class:this.ns.e("body")},[this.items.length>0?this.items.map((e=>a(s("iBizLocalVersionItem"),{key:e.id,item:e,items:this.items,controller:this.controller,onAction:(e,t,i)=>{this.handleAction(e,t,i)}},null))):a(s("iBizNoData"),null,null)])])}});const M=(e,t)=>{const i=new Date(e),n=i.getFullYear(),r=String(i.getMonth()+1).padStart(2,"0"),a=String(i.getDate()).padStart(2,"0"),o=String(i.getHours()).padStart(2,"0"),s=String(i.getMinutes()).padStart(2,"0"),c=String(i.getSeconds()).padStart(2,"0");return t.replace(/YYYY/g,String(n)).replace(/MM/g,r).replace(/DD/g,a).replace(/HH/g,o).replace(/mm/g,s).replace(/ss/g,c)};var U=t({name:"IBizLocalVersionItem",props:{item:{type:Object,required:!0},items:{type:Object,required:!0},controller:{type:Object,required:!0}},emits:{action:(e,t,i)=>!0},setup(e,{emit:t}){const i=m("local-version-item"),n=r(!1),o=r(e.item.caption),u=c((()=>e.items.length>1)),d=c((()=>e.item.id===e.controller.activeItemId)),h=c((()=>M(e.item.timestamp,"YYYY-MM-DD HH:mm:ss"))),p=async t=>{n.value=!1;await e.controller.updateCaption(e.item.id,t)||(ibiz.message.error("版本名称变更失败"),o.value=e.item.caption)},v=r();return{ns:i,timeStr:h,editing:n,showCompare:u,isActive:d,actionClick:(i,n)=>{t("action",i,e.item,n)},renderInput:()=>n.value?(l((()=>{var e;null==(e=v.value)||e.focus()})),a(s("el-input"),{ref:v,modelValue:o.value,"onUpdate:modelValue":e=>o.value=e,placeholder:"请输入版本名称",onChange:p,onBlur:()=>{n.value=!1}},null)):o.value}},render(){return a("div",{class:[this.ns.b(),this.ns.is("active",this.isActive)]},[a("div",{class:this.ns.b("left")},[a("div",{class:this.ns.b("left-top")},[this.renderInput(),this.editing?null:a("ion-icon",{name:"create-outline",onClick:()=>{this.editing=!this.editing}},null)]),a("div",{class:this.ns.b("left-bottom")},[a("div",null,[this.timeStr]),a("div",null,[this.item.username])])]),a("div",{class:this.ns.b("right")},[a(s("el-button"),{title:"切换至此版本",class:this.ns.is("hidden",this.isActive),onClick:e=>{this.actionClick("apply",e)}},{default:()=>[a("ion-icon",{name:"repeat"},null),o("应用")]}),a(s("el-popover"),{"popper-class":this.ns.e("popover"),placement:"bottom",width:80,trigger:"click"},{reference:()=>a(s("el-button"),{title:"更多",class:this.ns.is("hidden",this.isActive&&!this.showCompare)},{default:()=>[a("ion-icon",{name:"ellipsis-horizontal"},null)]}),default:()=>a("div",{class:this.ns.b("actions")},[!this.isActive&&a("div",{title:"删除版本",onClick:e=>{this.actionClick("remove",e)}},[a("ion-icon",{name:"trash"},null),o("删除版本")]),this.showCompare&&a("div",{title:"版本比对",onClick:e=>{this.actionClick("diff",e)}},[a("ion-icon",{name:"git-compare"},null),o("版本比对")])])})])])}});function R(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function B(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function q(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?B(Object(i),!0).forEach((function(t){R(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):B(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function _(e,t){if(null==e)return{};var i,n,r=function(e,t){if(null==e)return{};var i,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||(r[i]=e[i]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}function F(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function H(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Y(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function K(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Y(Object(i),!0).forEach((function(t){H(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Y(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function G(e){return function t(){for(var i=this,n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return r.length>=e.length?e.apply(this,r):function(){for(var e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return t.apply(i,[].concat(r,n))}}}function W(e){return{}.toString.call(e).includes("Object")}function J(e){return"function"==typeof e}var Q=G((function(e,t){throw new Error(e[t]||e.default)}))({initialIsRequired:"initial state is required",initialType:"initial state should be an object",initialContent:"initial state shouldn't be an empty object",handlerType:"handler should be an object or a function",handlersType:"all handlers should be a functions",selectorType:"selector should be a function",changeType:"provided value of changes should be an object",changeField:'it seams you want to change a field in the state which is not specified in the "initial" state',default:"an unknown error accured in `state-local` package"}),X={changes:function(e,t){return W(t)||Q("changeType"),Object.keys(t).some((function(t){return i=e,n=t,!Object.prototype.hasOwnProperty.call(i,n);var i,n}))&&Q("changeField"),t},selector:function(e){J(e)||Q("selectorType")},handler:function(e){J(e)||W(e)||Q("handlerType"),W(e)&&Object.values(e).some((function(e){return!J(e)}))&&Q("handlersType")},initial:function(e){var t;e||Q("initialIsRequired"),W(e)||Q("initialType"),t=e,Object.keys(t).length||Q("initialContent")}};function $(e,t){return J(t)?t(e.current):t}function Z(e,t){return e.current=K(K({},e.current),t),t}function ee(e,t,i){return J(t)?t(e.current):Object.keys(i).forEach((function(i){var n;return null===(n=t[i])||void 0===n?void 0:n.call(t,e.current[i])})),i}var te={create:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};X.initial(e),X.handler(t);var i={current:e},n=G(ee)(i,t),r=G(Z)(i),a=G(X.changes)(e),o=G($)(i);return[function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(e){return e};return X.selector(e),e(i.current)},function(e){!function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e){return t.reduceRight((function(e,t){return t(e)}),e)}}(n,r,a,o)(e)}]}};var ie,ne={configIsRequired:"the configuration object is required",configType:"the configuration object should be an object",default:"an unknown error accured in `@monaco-editor/loader` package",deprecation:"Deprecation warning!\n    You are using deprecated way of configuration.\n\n    Instead of using\n      monaco.config({ urls: { monacoBase: '...' } })\n    use\n      monaco.config({ paths: { vs: '...' } })\n\n    For more please check the link https://github.com/suren-atoyan/monaco-loader#config\n  "},re=(ie=function(e,t){throw new Error(e[t]||e.default)},function e(){for(var t=this,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return n.length>=ie.length?ie.apply(this,n):function(){for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return e.apply(t,[].concat(n,r))}})(ne),ae={config:function(e){var t;return e||re("configIsRequired"),t=e,{}.toString.call(t).includes("Object")||re("configType"),e.urls?(console.warn(ne.deprecation),{paths:{vs:e.urls.monacoBase}}):e}};function oe(e,t){return Object.keys(t).forEach((function(i){t[i]instanceof Object&&e[i]&&Object.assign(t[i],oe(e[i],t[i]))})),q(q({},e),t)}var se={type:"cancelation",msg:"operation is manually canceled"};function ce(e){var t=!1,i=new Promise((function(i,n){e.then((function(e){return t?n(se):i(e)})),e.catch(n)}));return i.cancel=function(){return t=!0},i}var le,ue,de=te.create({config:{paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs"}},isInitialized:!1,resolve:null,reject:null,monaco:null}),he=(ue=2,function(e){if(Array.isArray(e))return e}(le=de)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var i=[],n=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw a}}return i}}(le,ue)||function(e,t){if(e){if("string"==typeof e)return F(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?F(e,t):void 0}}(le,ue)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),pe=he[0],me=he[1];function ve(e){return document.body.appendChild(e)}function fe(e){var t,i,n=pe((function(e){return{config:e.config,reject:e.reject}})),r=(t="".concat(n.config.paths.vs,"/loader.js"),i=document.createElement("script"),t&&(i.src=t),i);return r.onload=function(){return e()},r.onerror=n.reject,r}function ye(){var e=pe((function(e){return{config:e.config,resolve:e.resolve,reject:e.reject}})),t=window.require;t.config(e.config),t(["vs/editor/editor.main"],(function(t){be(t),e.resolve(t)}),(function(t){e.reject(t)}))}function be(e){pe().monaco||me({monaco:e})}var we=new Promise((function(e,t){return me({resolve:e,reject:t})})),ge={config:function(e){var t=ae.config(e),i=t.monaco,n=_(t,["monaco"]);me((function(e){return{config:oe(e.config,n),monaco:i}}))},init:function(){var e=pe((function(e){return{monaco:e.monaco,isInitialized:e.isInitialized,resolve:e.resolve}}));if(!e.isInitialized){if(me({isInitialized:!0}),e.monaco)return e.resolve(e.monaco),ce(we);if(window.monaco&&window.monaco.editor)return be(window.monaco),e.resolve(window.monaco),ce(we);!function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e){return t.reduceRight((function(e,t){return t(e)}),e)}}(ve,fe)(ye)}return ce(we)},__getMonacoInstance:function(){return pe((function(e){return e.monaco}))}};var De=t({props:{current:{type:Object,required:!0},items:{type:Object,required:!0}},setup(e){const t=m("local-version-diff"),a=r(!1),o=r(e.items.find((t=>t.id!==e.current.id))||e.current),s=r();let c,l,d,h,p;const{UIStore:f}=v(),y=e=>"dark"===e?"vs-".concat(f.theme):"vs";u((()=>f.theme),(e=>{null==c||c.setTheme(y(e)),null==l||l.layout()}));return i((()=>{(async()=>{if(s.value)try{a.value=!0,ge.config({paths:{vs:"".concat(ibiz.env.pluginBaseUrl,"/monaco-editor@0.45.0/min/vs")}});const t=await ge.init();c=t.editor,l=c.createDiffEditor(s.value,{theme:y(f.theme),readOnly:!0,readOnlyMessage:{value:ibiz.i18n.t("editor.code.readOnlyPrompt")}}),d=c.createModel(e.current.data?JSON.stringify(e.current.data,null,2):"","json"),h=c.createModel(o.value.data?JSON.stringify(o.value.data,null,2):"","json"),l.setModel({original:d,modified:h})}finally{a.value=!1}})(),s.value&&(p=new ResizeObserver((()=>{null==l||l.layout()})),p.observe(s.value))})),n((()=>{null==p||p.disconnect()})),{ns:t,isLoading:a,selectedItem:o,diffEditorRef:s,handleSelectChange:t=>{o.value=e.items.find((e=>e.id===t))||e.current,l&&c&&d&&h&&(h.setValue(o.value.data?JSON.stringify(o.value.data,null,2):""),l.setModel({original:d,modified:h}))}}},render(){let e;return d(a("div",{class:this.ns.b()},[a("div",{class:this.ns.b("header")},[o("版本比对")]),a("div",{class:this.ns.b("content")},[a("div",{class:this.ns.b("toolbar")},[a(s("el-select"),{"model-value":this.current.id,disabled:!0},{default:()=>[a(s("el-option"),{value:this.current.id,label:this.current.caption},null)]}),a(s("el-select"),{"model-value":this.selectedItem.id,onChange:this.handleSelectChange},(t=e=this.items.map((e=>a(s("el-option"),{key:e.id,value:e.id,label:e.caption},null))),"function"==typeof t||"[object Object]"===Object.prototype.toString.call(t)&&!p(t)?e:{default:()=>[e]}))]),a("div",{class:this.ns.b("editor"),ref:"diffEditorRef"},null)])]),[[h("loading"),this.isLoading]]);var t}}),Ie={install(e){e.component("IBizLocalVersionContainer",k),e.component("IBizLocalVersionList",z),e.component("IBizLocalVersionItem",U),e.component("IBizLocalVersionDiff",De)}};class Oe extends f{async inputHandle(e,t){return x(t)?t:this.input.handle(e,t)}async inputFormat(e,t){const i=async t=>this.input.format(e,t);if(Array.isArray(t)){const e=[];for(let n=0;n<t.length;n++)e.push(await i(t[n]));return e}return i(t)}async getMethod(e,t=!1){const i=y(this.entity,e);if(!i)throw new A("未找到服务方法: ".concat(e));const n=await b(i);if(!n)throw new A("未支持的服务方法类型: ".concat(i.methodType));return n.create(this.service,this.entity,i,{acMode:t,localMode:this.service.isLocalMode})}async exec(e,t,i,n){let r;if(!e.srfappid)return new L({});if(t&&!["READ","GETDRAFT"].includes(this.method.actionMode)&&await w(this.entity,"change",e,t,i),"DELOGIC"===this.method.actionType){const n=g(this.method.appDELogicId,this.entity);if(!n)throw new P(this.method,ibiz.i18n.t("runtime.service.lackEntityLogic"));r=await D(n,e,t,i)}else{t&&(t=this.isLocalMode?await this.inputFormat(e,t):await this.inputHandle(e,t));const a=this.method.actionTag?this.method.actionTag.toUpperCase():this.method.codeName.toUpperCase();switch(this.method.beforeCode&&await I.asyncExecScriptFn({context:e,data:t,viewParam:i,activeData:n},this.method.beforeCode),r=new L,a){case"GETTEMPREALTIMEDATA":r=await this.getTempRealTimeData(e,t);break;case"UPDATETEMPREALTIMEDATA":r=await this.updateTempRealTimeData(e,t,i);break;default:throw new A("".concat(a,"暂未支持"))}}return this.method.afterCode&&await I.asyncExecScriptFn({context:e,data:r.data,viewParam:i,activeData:n},this.method.afterCode),r.data&&await w(this.entity,"compute",e,r.data,i),r}async getTempRealTimeData(e,t){try{let i=null;t&&(i=t[this.entity.keyAppDEFieldId.toLowerCase()]),!i&&e&&(i=e[this.entity.codeName.toLowerCase()]);let n=this.service.local.get(e,i);if(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e)){const t=n[e];"object"!=typeof t||T(t)||(n[e]=void 0)}const t=await this.getMethod("update");n=await t.input.handle(e,n)}return n?new L(n):new L(n,500)}catch(e){throw new N(e)}}async updateTempRealTimeData(e,t,i){const n=await this.getMethod("update"),r=await n.result.handle(e,t);this.service.local.add(e,r);const a=ibiz.uiDomainManager.get(e.srfsessionid);return a&&!1===a.dataModification&&(a.dataModification=!0),new L(r)}}class je{create(e,t,i,n){return new Oe(e,t,i,n.localMode)}}var Se={install(e){O("DEMETHOD_REAL_TIME_DATA",(()=>new je))}};const Ce="local_version_overup_isclean";var Ee=Object.defineProperty,Ae=(e,t,i)=>(((e,t,i)=>{t in e?Ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Le extends j{constructor(){super(...arguments),Ae(this,"timestamp",Date.now()),Ae(this,"isSaveing",!1),Ae(this,"isDirty",!1)}}class Pe{constructor(e,t,i,n,r,a){this.index=e,this.id=t,this.caption=i,this.username=n,this.timestamp=r,this.data=a}}var Ne=Object.defineProperty,xe=(e,t,i)=>(((e,t,i)=>{t in e?Ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Te{constructor(e,t,i,n,r){xe(this,"dbName"),xe(this,"storeName"),xe(this,"dbVersion"),xe(this,"storeConfig"),xe(this,"maxRecords"),this.dbName=e,this.storeName=t,this.storeConfig=i,this.maxRecords=n,this.dbVersion=r}async openDatabase(){return new Promise(((e,t)=>{const i=indexedDB.open(this.dbName,this.dbVersion);i.onupgradeneeded=e=>{const t=i.result;if(!t.objectStoreNames.contains(this.storeName)){t.createObjectStore(this.storeName,this.storeConfig).createIndex("timestamp_idx","timestamp",{unique:!1})}},i.onsuccess=()=>e(i.result),i.onerror=()=>t(i.error)}))}async enforceDomainMaxRecords(e,t){if(!(this.maxRecords<=0))return new Promise(((i,n)=>{const r=t?IDBKeyRange.bound(t,"".concat(t,"￿"),!1,!1):void 0,a=e.count(r);a.onsuccess=()=>{if(a.result<this.maxRecords)return void i();const r=e.index("timestamp_idx").openCursor(null,"next");r.onsuccess=()=>{const e=r.result;if(e){const n=e.value;t?n.id&&n.id.startsWith(t)?e.delete().onsuccess=()=>i():e.continue():e.delete().onsuccess=()=>i()}else i(void 0)},r.onerror=()=>{n(r.error)}},a.onerror=()=>n(a.error)}))}async databaseExists(){return(await indexedDB.databases()).some((e=>e.name===this.dbName))}async storeExists(){const e=await this.openDatabase(),t=e.objectStoreNames.contains(this.storeName);return e.close(),t}async add(e){const t=await this.openDatabase();return new Promise(((i,n)=>{const r=t.transaction(this.storeName,"readwrite"),a=r.objectStore(this.storeName),o=e.id.slice(0,e.id.lastIndexOf("@"));this.enforceDomainMaxRecords(a,o).then((()=>{const t=a.add(e);t.onsuccess=()=>i(t.result),t.onerror=()=>n(t.error)})).catch(n),r.oncomplete=()=>t.close(),r.onerror=()=>{t.close(),n(r.error)}}))}async delete(e){const t=await this.openDatabase();return new Promise(((i,n)=>{const r=t.transaction(this.storeName,"readwrite");r.objectStore(this.storeName).delete(e),r.oncomplete=()=>{t.close(),i()},r.onerror=()=>{t.close(),n(r.error)}}))}async deleteAll(e,t){const i=await this.openDatabase();return new Promise(((n,r)=>{const a=i.transaction(this.storeName,"readwrite"),o=a.objectStore(this.storeName),s=IDBKeyRange.bound(e,"".concat(e,"￿"),!1,!1);o.openCursor(s).onsuccess=e=>{const i=e.target.result;if(i){const e=i.value;t?e.id!==t&&i.delete():i.delete(),i.continue()}},a.oncomplete=()=>{i.close(),n()},a.onerror=()=>{i.close(),r(a.error)}}))}async update(e,t){const i=await this.openDatabase();return new Promise(((e,n)=>{const r=i.transaction(this.storeName,"readwrite");r.objectStore(this.storeName).put(t),r.oncomplete=()=>{i.close(),e()},r.onerror=()=>{i.close(),n(r.error)}}))}async get(e){const t=await this.openDatabase();return new Promise(((i,n)=>{const r=t.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);r.onsuccess=()=>{t.close(),i(r.result?r.result:void 0)},r.onerror=()=>{t.close(),n(r.error)}}))}async getAll(e,t){const i=await this.openDatabase();return new Promise(((n,r)=>{const a=i.transaction(this.storeName,"readonly").objectStore(this.storeName).index("timestamp_idx"),o=[],s=a.openCursor(null,"prev");s.onsuccess=r=>{var a;const s=r.target.result;if(s){const i=s.value;e?i.id&&i.id.startsWith(e)&&(t?(null==(a=i.caption)?void 0:a.toLowerCase().includes(t.toLowerCase()))&&o.push(i):o.push(i)):o.push(i),s.continue()}else i.close(),n(o)},s.onerror=()=>{i.close(),r(s.error)}}))}async getLastByTimestamp(e){const t=await this.openDatabase();return new Promise(((i,n)=>{const r=t.transaction(this.storeName,"readonly").objectStore(this.storeName).index("timestamp_idx").openCursor(null,"prev");r.onsuccess=()=>{const n=r.result;if(n){const r=n.value;e?r.id&&r.id.startsWith(e)?(t.close(),i(r)):n.continue():(t.close(),i(r))}else t.close(),i(void 0)},r.onerror=()=>{t.close(),n(r.error)}}))}async count(e){const t=await this.openDatabase();return new Promise(((i,n)=>{const r=t.transaction(this.storeName,"readonly").objectStore(this.storeName),a=e?IDBKeyRange.bound(e,"".concat(e,"￿"),!1,!1):void 0,o=r.count(a);o.onsuccess=()=>{t.close(),i(o.result)},o.onerror=()=>{t.close(),n(o.error)}}))}}var Ve=Object.defineProperty,ke=(e,t,i)=>(((e,t,i)=>{t in e?Ve(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class ze{constructor(e,t,i,n,r,a,o){this.view=e,this.appDataEntity=t,ke(this,"db"),ke(this,"evt",new S),ke(this,"activeItemId"),ke(this,"isDirty",!1),ke(this,"overUpNumber",0),ke(this,"overUpIsClean",!0),this.db=new Te(i,n,r,a,o),this.overUpNumber=a}getOverUpState(){const e=localStorage.getItem(Ce);return this.overUpIsClean=!e||"true"===e,{overUpNumber:this.overUpNumber,overUpIsClean:this.overUpIsClean}}setOverUpState(e){this.overUpIsClean=e,localStorage.setItem(Ce,e?"true":"false")}getLocalVersionKey(e,t){var i;return"".concat(this.view.context.psdevslnsys,"@").concat(null==(i=this.appDataEntity.codeName)?void 0:i.toLowerCase(),"@").concat(e[this.appDataEntity.keyAppDEFieldId],"@").concat(t)}getLocalVersionDomain(){var e,t;return"".concat(this.view.context.psdevslnsys,"@").concat(null==(e=this.appDataEntity.codeName)?void 0:e.toLowerCase(),"@").concat(this.view.context[null==(t=this.appDataEntity.codeName)?void 0:t.toLowerCase()])}async checkEnableAdd(e){let t=!0;const i=await this.db.getLastByTimestamp(this.getLocalVersionDomain());if(i){const n=i.data;JSON.stringify(n)===JSON.stringify(e)&&(t=!1)}return{ret:t,data:i}}async add(e,t=!0){const{ret:i,data:n}=await this.checkEnableAdd(e);if(!i)return this.activeItemId=n.id,n;const{overUpIsClean:r}=this.getOverUpState();if(!r&&t){if(await this.db.count(this.getLocalVersionDomain())>=this.overUpNumber){if(!await ibiz.confirm.warning({title:"超出上限",desc:"当前数据量超出上限".concat(this.overUpNumber,"条，是否清除超出数据并继续保存？")}))return void(this.activeItemId=n.id)}}const a=Date.now();let o=0;n&&void 0!==n.index&&(o=n.index+1);const s=new Pe(o,this.getLocalVersionKey(e,a),"".concat(e[this.appDataEntity.majorAppDEFieldId],"_V").concat(o+1),this.view.context.srfusername,a,e);return await this.db.add(s),this.activeItemId=s.id,s}async manualAdd(e,t){const{ret:i,data:n}=await this.checkEnableAdd(e);if(!i)return ibiz.log.warn("传入数据和最近版本数据一致，忽略处理"),n;const{overUpIsClean:r}=this.getOverUpState();if(!r){if(await this.db.count(this.getLocalVersionDomain())>=this.overUpNumber){if(!await ibiz.confirm.warning({title:"超出上限",desc:"当前数据量超出上限".concat(this.overUpNumber,"条，是否清除超出数据并继续保存？")}))return}}const a=Date.now();let o=0;n&&void 0!==n.index&&(o=n.index+1);const s=new Pe(o,this.getLocalVersionKey(e,a),t||"".concat(e[this.appDataEntity.majorAppDEFieldId],"_V").concat(o+1),this.view.context.srfusername,a,e);return await this.db.add(s),s}async fetchAll(e){try{return await this.db.getAll(this.getLocalVersionDomain(),e)}catch(e){return ibiz.log.error(e),[]}}async apply(e){const t=ibiz.hub.getApp(this.appDataEntity.appId),i=await t.deService.getService(this.view.context,this.appDataEntity.id);if(this.isDirty){if(!await ibiz.confirm.warning({title:"应用历史版本",desc:"检测到未保存的修改，应用历史版本前将自动保存当前更改。此操作不可撤销，是否继续？"}))return!1;const e=await i.exec("GetTempRealTimeData",this.view.context,this.view.params);if(e.ok&&e.data){const t=await this.add(e.data,!1);t&&this.evt.emit("update",t)}}try{const t=await i.exec("UpdateTempRealTimeData",this.view.context,e.data,this.view.params);return!(!t.ok||!t.data)&&(this.activeItemId=e.id,this.evt.emit("close"),this.view.call("Refresh",{ignoreLoad:!0}),this.evt.emit("update",e),!0)}catch(e){return!1}}async remove(e){if(!await ibiz.confirm.warning({title:"数据删除",desc:"确认删除数据？"}))return!1;try{await this.db.delete(e.id)}catch(e){return ibiz.message.error("删除数据失败"),!1}return!0}async diff(e,t){const i=ibiz.overlay.createModal("IBizLocalVersionDiff",{current:e,items:t.filter((t=>t.id!==e.id))},{width:"80%",height:"80%",footerHide:!0});return i.present(),await i.onWillDismiss(),e}async updateCaption(e,t){try{const i=await this.db.get(e);return i.caption=t,await this.db.update(e,i),!0}catch(e){return!1}}async deleteAll(e=!0){if(!await ibiz.confirm.warning({title:"数据删除",desc:"确认删除除当前激活项外的所有历史版本数据？"}))return!1;try{return e?await this.db.deleteAll(this.getLocalVersionDomain(),this.activeItemId):await this.db.deleteAll(this.getLocalVersionDomain()),this.evt.emit("deleteAll"),!0}catch(e){return ibiz.log.error("删除除当前激活项外的所有历史版本数据异常"),!1}}}var Me=Object.defineProperty,Ue=(e,t,i)=>(((e,t,i)=>{t in e?Me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Re extends C{constructor(){super(...arguments),Ue(this,"rawItemParams",{}),Ue(this,"versionControl"),Ue(this,"appDataEntity"),Ue(this,"service"),Ue(this,"intervaler"),Ue(this,"viewEditEventNames",["onCreateSuccess","onRemoveSuccess","onUpdateSuccess","onEditAction","onRefreshPanel"]),Ue(this,"updateVersion",(e=>{this.state.timestamp=e.timestamp,this.updateDirty(!1)})),Ue(this,"updateDirty",(e=>{this.state.isDirty=e,this.versionControl.isDirty=e}))}createState(){var e;return new Le(null==(e=this.parent)?void 0:e.state)}get view(){return this.panel.view}async onInit(){await super.onInit(),await this.initBaseParams(),await this.initVersionControl(),await this.intervalSave(),await this.subscribeUserAction()}async initBaseParams(){var e;const t={},i=null==(e=this.model.rawItem)?void 0:e.rawItemParams;V(i)&&i&&i.forEach((e=>{t[e.key.toLowerCase()]=e.value})),Object.assign(this.rawItemParams,t),this.appDataEntity=await ibiz.hub.getAppDataEntity(this.view.model.appDataEntityId,this.model.appId);const n=ibiz.hub.getApp(this.view.model.appId);this.service=await n.deService.getService(this.view.context,this.view.model.appDataEntityId)}async initVersionControl(){var e;this.versionControl=new ze(this.view,this.appDataEntity,this.rawItemParams.dbname||"ibiz-".concat(null==(e=this.appDataEntity.codeName)?void 0:e.toLowerCase()),this.rawItemParams.storename||"local-version",this.rawItemParams.storeConfig||{keyPath:"id",autoIncrement:!1},this.rawItemParams.maxrecords?Number(this.rawItemParams.maxrecords):20,this.rawItemParams.dbversion?Number(this.rawItemParams.dbversion):1),await this.saveLocalVersion()}async intervalSave(){this.intervaler=setInterval((async()=>{await this.saveLocalVersion()}),this.rawItemParams.INTERVALTIME?Number(this.rawItemParams.INTERVALTIME):3e5)}handleKeyDown(e){(e.ctrlKey||e.metaKey)&&"s"===e.key.toLowerCase()&&(e.preventDefault(),this.saveLocalVersion())}async subscribeUserAction(){var e,t;this.saveLocalVersion=this.saveLocalVersion.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.updateVersion=this.updateVersion.bind(this),this.view.evt.on("onSaveSuccess",this.saveLocalVersion),window.addEventListener("keydown",this.handleKeyDown),null==(e=this.versionControl)||e.evt.on("update",this.updateVersion);const i=ibiz.uiDomainManager.get(this.view.context.srfsessionid);null==(t=null==i?void 0:i.evt)||t.on("stateChange",(({state:e,isTrusted:t})=>{e&&t&&this.updateDirty(!0)}))}async unSubscribeUserAction(){var e;this.view.evt.off("onSaveSuccess",this.saveLocalVersion),window.removeEventListener("keydown",this.handleKeyDown),null==(e=this.versionControl)||e.evt.off("update",this.updateVersion)}async saveLocalVersion(){const e=await this.service.exec("GetTempRealTimeData",this.view.context,this.view.params);if(e.ok&&e.data){this.state.isSaveing=!0;const t=await this.versionControl.add(e.data);t&&(this.state.timestamp=t.timestamp,this.updateDirty(!1)),this.state.isSaveing=!1}}destroy(){super.destroy(),this.intervaler&&clearInterval(this.intervaler),this.unSubscribeUserAction()}}var Be=t({name:"IBizLocalVersionTag",props:{modelData:{type:Object,required:!0},controller:{type:Re,required:!0}},setup(e){const t=m("local-version-tag"),i=e.controller,{state:n}=i,r=c((()=>M(n.timestamp,"YYYY-MM-DD HH:mm:ss")));return{ns:t,state:n,timeStr:r,openVersionList:async()=>{const e=ibiz.overlay.createDrawer("IBizLocalVersionContainer",{controller:i.versionControl,dismiss:()=>e.dismiss()},{width:600,placement:"right"});await e.present();return await e.onWillDismiss()||{ok:!1}}}},render(){return a("div",{class:this.ns.b()},[a("div",{class:[this.ns.b("state"),this.ns.is("dirty",this.state.isDirty)]},null),a("div",{class:this.ns.b("caption"),onClick:()=>this.openVersionList()},[a("div",{class:this.ns.be("caption","version")},[o("本地历史版本")]),a("div",{class:this.ns.be("caption","timestamp")},[a("span",null,[this.timeStr]),a("span",null,[o("  ")]),a("span",null,[this.state.isDirty?"工作区变更":"保存完成"])])])])}}),qe=Object.defineProperty,_e=(e,t,i)=>(((e,t,i)=>{t in e?qe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);class Fe{constructor(){_e(this,"component","IBizLocalVersionTag")}async createController(e,t,i){const n=new Re(e,t,i);return await n.init(),n}}var He={install(e){e.component("IBizLocalVersionTag",Be),E("RAWITEM_LOCAL_VERSION_TAG",(()=>new Fe))}},Ye={install(e){e.use(He)}};e("default",{install(e){e.use(Ie),e.use(Se),e.use(Ye)}})}}}));

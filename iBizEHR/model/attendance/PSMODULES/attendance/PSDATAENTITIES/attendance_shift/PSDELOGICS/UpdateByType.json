{
  "codeName" : "UpdateByType",
  "defaultParamName" : "DEFAULT",
  "dynaModelFilePath" : "PSMODULES/attendance/PSDATAENTITIES/attendance_shift/PSDELOGICS/UpdateByType.json",
  "logicName" : "修改班次信息",
  "name" : "修改班次信息",
  "scriptCode" : "console.log('UpdateByType临时数据创建:');\r\n\r\nconst serviceUtil = ibiz.hub.getApp(context.srfappid).deService;\r\nconst service = await serviceUtil.getService(context, 'attendanceapp.attendance_shift');\r\nif(data.default_flag === false || data.default_flag === \"false\") {\r\n    data.default_flag = 0\r\n}\r\n\r\nif (data.default_flag === 1 && data.workday_id&& (data.schedule_type === 'fixed' || data.schedule_type === 'flexible' || data.schedule_type === 'alternate_week')) {\r\n    console.log('创建工作日班次:', data);\r\n\r\n    //获取默认shift\r\n    const list = service.local.getList(context);\r\n    const defaultShift = list.find(item =>item.default_flag == 1 );\r\n\r\n    const curScopes = data.scopes;\r\n    // 获取所有班次临时数据\r\n    const beforeScopes =defaultShift.scopes;\r\n\r\n    if (beforeScopes.length > 0 && curScopes.length > 0) {\r\n        // 与默认班次信息对比\r\n        const areScopesEqual = compareScopes(beforeScopes, curScopes);\r\n\r\n        if (!areScopesEqual) {\r\n            data.id =null;\r\n            data.default_flag = 0;\r\n            data.public_flag = 0;\r\n            curScopes.forEach(item => {\r\n                item.shift_id =null\r\n            })\r\n\r\n            //为工作日创建班次\r\n            const res = await service.exec('CreateTemp', context, data);\r\n\r\n            if (res && res.ok) {\r\n                data = res.data;\r\n                console.log('临时数据创建成功:', res);\r\n            }\r\n            const workdayService = await serviceUtil.getService(context, 'attendanceapp.attendance_workday');\r\n\r\n            const workday = await workdayService.local.get(context, data.workday_id);\r\n            console.log('workday临时数据获取成功:', workday);\r\n            workday.shift_id = data.id;\r\n            const workdayRes = await workdayService.updateTemp(context, workday)\r\n            if (workdayRes && res.workdayRes) {\r\n                console.log('workday临时数据更新成功:', workdayRes);\r\n            }\r\n        }else {\r\n            const res = await service.updateTemp(context, data)\r\n            if (res && res.ok) {\r\n                console.log('临时数据更新成功:', res);\r\n            }\r\n        }\r\n\r\n        // 班次信息对比\r\n        function compareScopes(beforeScopes, curScopes) {\r\n            if (beforeScopes.length !== curScopes.length) return false;\r\n\r\n            for (let i = 0; i < beforeScopes.length; i++ ) {\r\n                const defaultItem = beforeScopes[i];\r\n                const curItem = curScopes[i];\r\n\r\n                if (typeof defaultItem !== 'object' || typeof curItem !== 'object' ) {\r\n                    return false;\r\n                }\r\n\r\n                if (\r\n                    defaultItem.early_for_absenteeism !== curItem.early_for_absenteeism ||\r\n                    defaultItem.early_for_early !== curItem.early_for_early ||\r\n                    defaultItem.latest_checkout !== curItem.latest_checkout ||\r\n                    defaultItem.earliest_checkin !== curItem.earliest_checkin ||\r\n                    defaultItem.end_base_time !== curItem.end_base_time ||\r\n                    defaultItem.late_for_absenteeism !== curItem.late_for_absenteeism ||\r\n                    defaultItem.late_for_late !== curItem.late_for_late ||\r\n                    defaultItem.start_base_time !== curItem.start_base_time\r\n                ) {\r\n                    return false;\r\n                }\r\n            }\r\n            return true;\r\n        }\r\n    }\r\n\r\n} else {\r\n    const res = await service.exec('UpdateTemp', context, data);\r\n    if (res && res.ok) {\r\n        console.log('临时数据shift更新成功:', res);\r\n    }\r\n}",
  "customCode" : true,
  "enableBackend" : false,
  "enableFront" : true
}